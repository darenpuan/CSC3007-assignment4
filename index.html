<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
  </head>
  <body>
    <svg></svg>
    <div class="tooltip"></div>

    <script>
      let width = 800,
        height = 400;

      let svg = d3.select("svg").attr("viewBox", "0 0 " + width + " " + height);

      // Load external data
      Promise.all([
        d3.json("/assets/links-sample.json"),
        d3.json("/assets/cases-sample.json"),
      ]).then((data) => {
        // Data preprocessing
        data[0].forEach((e) => {
          e.source = e.infector;
          e.target = e.infectee;
        });

        let links = data[0];
        let cases = data[1];
        let xPosition = d3.scaleOrdinal().domain([0, 1]).range([200, 400]);

        console.log(links); //links
        console.log(cases); //cases

        let node = svg
          .append("g")
          .attr("id", "nodes")
          .selectAll("circle")
          .data(cases)
          .enter()
          .append("circle")
          .attr("r", 25)
          .style("fill", function (d) {
            if (d.gender == "male") {
              return "lightblue";
            } else {
              return "pink";
            }
          })

          .call(
            d3
              .drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended)
          );

        let img = svg
          .append("g")
          .selectAll("img")
          .data(cases)
          .enter()
          .append("image")
          .attr("xlink:href", function (d) {
            if (d.gender == "male") {return "/assets/img/man.png"}
            else {return "/assets/img/woman.png"};
          })
          .attr("width", 30)
          .attr("height", 30)
          .attr("pointer-events", "none"); // without this if user click on img, cannot drag

        let linkpath = svg
          .append("g")
          .attr("id", "links")
          .selectAll("path")
          .data(links)
          .enter()
          .append("path")
          .attr("fill", "none")
          .attr("stroke", "black");

        function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }

        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }

        function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }

        let simulation = d3
          .forceSimulation()
          .nodes(cases)
          .force(
            "x",
            d3
              .forceX()
              .strength(0.1)
              .x(function (d) {
                return xPosition(d.class);
              })
          )
          .force(
            "y",
            d3
              .forceY()
              .strength(0.1)
              .y(height / 2)
          )
          .force(
            "link",
            d3
              .forceLink(links)
              .id((d) => d.id)
              .distance(100)
              .strength(0.5)
          )
          .force("charge", d3.forceManyBody().strength(20))
          .force("collide", d3.forceCollide().strength(1).radius(30))
          .on("tick", (d) => {
            node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);

            linkpath.attr(
              "d",
              (d) =>
                "M" +
                d.source.x +
                "," +
                d.source.y +
                " " +
                d.target.x +
                "," +
                d.target.y
            );
            img.attr("x", (d) => d.x - 14).attr("y", (d) => d.y - 16);
          });
      });
    </script>
  </body>
</html>
